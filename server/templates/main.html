<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0" />
	<title>记账</title>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/axios@0.12.0/dist/axios.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
		integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
		integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
		crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
		integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
		integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
		crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
		integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
	<style>
		/* html{height: 100px;} */
		body {
			margin-bottom: 74px;
		}

		.submit-btn {
			width: 100%;
			/* position: absolute; */
			/* bottom: 0; */
			background: rgb(29, 161, 250);
			/* margin-top:50px; */
			/* height: 50px; */
			text-align: center;
			font-size: 40px;
			margin: 0px auto;
			display: table;
		}
	</style>
</head>

<body>

	{% with messages = get_flashed_messages() %}
	{% if messages %}
	<ul class=flashes>
		{% for message in messages %}
		<li>{{ message }}</li>
		{% endfor %}
	</ul>
	{% endif %}
	{% endwith %}
	<div id="app">
		<div class="container-fluid">
			<h1>总消费:{{total}}美元</h1>
			<form>
				<div class="row">
					<div class="form-group col-sm-4">
						<label for="dateInput" class="col-form-label col-sm-12">日期</label>
						<div class="col-sm-12">
							<input v-model:value="date" type="date" class="form-control" id="dateInput">
							<small>每天都要记账!</small>
						</div>
						<label for="affiliated" class="col-form-label col-sm-12">想说的话</label>
						<div class="col-sm-12">
							<textarea v-model:value="costs.affiliated" rows=10 class="form-control"
								id="affiliated"></textarea>
						</div>
					</div>
					<div class="col-sm-8">
						<div v-if="costs.records.length===0">
							<h4>今天竟然没花钱?</h4>
						</div>
						<div v-for="(record, index) in costs.records" class="form-group col-sm-12">
							<bar v-bind:index="index" v-bind:record="record" @sendnew="switchNew" @remove="remove">
							</bar>
						</div>
						<div class="col-sm-12" style="text-align: center; color:#F4B400; text-shadow: 1px 1px #CCCCCC;">
							<i class="fas fa-4x fa-plus-circle" @click="addNew"></i>
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">不能添加新条目</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>请先将已有的条目都填写完整.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-dismiss="modal">知道了</button>
				</div>
			</div>
		</div>

	</div>
</body>
<!-- <div id="submit-btn" class="navbar fixed-bottom" style="margin: 0; padding: 0">
	<button @click="submit" class="btn submit-btn"
		style="background:#00343F; color:#EEEEEE; border-radius: 0; border:0; padding: 0px;">提交记录</button>
</div> -->
<script>
	Vue.component('bar', {
		data: function () {
			return {
				options: [
					{ id: 1, value: "daily", text: "日常消费" },
					{ id: 2, value: "tex", text: "税" },
					{ id: 3, value: "onetime", text: "一次性" }
				],
			}
		},
		props: ['record', 'index'],
		//updated: function () {
		//	alert('to emit')
		//	this.$emit('sendnew', { index: this.index, truethy: this.new })
		//},
		computed: {
			new: function () {
				var truethy = true
				if (this.record.cost === "" || parseFloat(this.record.cost) <= 0 || this.record.type === "") {
					truethy = true
				} else {
					truethy =  false
				}
				this.$emit('sendnew', {index: this.index, truethy: truetry})
				
			}
		},
		methods: {
			remove() {
				alert('remove my self')
				this.$emit('remove', { index: this.index })
			}
		},
		template:
			`
		<div class= "input-group">
			<select class="custom-select" v-model="record.type">
				<option disabled selected value="">消费类型</option>
				<option v-for="opt in options" :value="opt.value">{{opt.text}}</option>
			</select>
			<div class="input-group-prepend">
				<span class="input-group-text">$</span>
			</div>
			<input type="number" step=0.01 class= "form-control"
				aria-label="cost" v-model:value="record.cost" aria-describedby="cst-addon1" />
			<input name="itemName" v-model:value="record.item" type="text"/>
			<button class="input-group-append" style="padding: 0; border-radius: 0; border:0"><span class="btn btn-danger" @click="remove">
				<i class="fas fa-minus-circle"></i>
			</span></button>
		</div>`

	})
	
	app = new Vue({
		el: "#app",
		data: {
			costs: { records: [] },
			date: "",
			abc: "tex",
			nextId: 0
		},
		created: function () {
			this.date = "2019-02-23"
			//	this.query()
		},
		watch: {
			date: function () {
				console.log("new date", this.date)
				this.query()
			}
		},
		computed: {

			total: function () {
				return this.summ(this.costs)
			},
			submit_form: function () {
				return { date: this.date, costs: this.costs }
			},
			allowAdd: function () {
				var tmpStatus = false
				for (var ind in this.costs.records) {
					tmpStatus = this.costs.records[ind].new || tmpStatus
					if (tmpStatus === true) return false
				}
				return true
			}
		},
		methods: {
			query() {
				var vm = this
				var url = "/api/get/" + this.date
				axios.get(url).then(function (response) {
					console.log(response.data)
					if (response.data.status === false) {
						vm.costs = { "affiliated": "", records: [] }
						vm.addNew()
					} else {
						vm.costs = response.data
					}
				})
			},
			summ: function (costs) {
				var tmp = 0;
				for (var ind in costs.records) {
					if (costs.records[ind].cost === "" || costs.records[ind].cost === null) { continue }
					tmp += parseFloat(costs.records[ind].cost)
				}
				return tmp.toFixed(2)
			},
			remove(data) {
				alert('remove in app')
				this.costs.records.splice(data.index, 1)
			},
			addNew() {
				if (this.allowAdd) {
					this.nextId++
					this.costs.records.push({ "id": this.nextId, "type": "", "cost": 0, "item": "", new: true })
				}
				else {
					$('#myModal').modal()
				}
			},
			switchNew: function (data) {
				this.costs.records[data.index].new = data.truethy
			},
		}
	})
</script>

</html>